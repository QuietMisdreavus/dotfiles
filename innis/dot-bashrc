#
# ~/.bashrc
#

# If not running interactively, don't do anything
[[ $- != *i* ]] && return

if [ `which exa` ]; then
    alias ls=exa
    alias tree="exa --tree"
else
    alias ls="ls -G"
fi

# color codes used in prompt
reset=$(tput sgr0)
cyan=$(tput setaf 14)
blue=$(tput setaf 12)
red=$(tput setaf 9)

# check if last exit code was nonzero and print it if so
function nonzero_return() {
    RETVAL=$?
    [ $RETVAL -ne 0 ] && echo -n " - $red$RETVAL$reset"
}

# check dirs stack and background jobs and print if more than default
function ps1_dirs_jobs() {
    DIRCOUNT=`dirs -p | wc -l`
    JOBCOUNT=`jobs | wc -l`
    PRINTSECTION=
    [ $DIRCOUNT -gt 1 -o $JOBCOUNT -gt 0 ] && PRINTSECTION=yes
    if [ $PRINTSECTION ] ; then
        echo -n " -$cyan"
        [ $DIRCOUNT -gt 1 ] && echo -n " dirs:${DIRCOUNT//[[:space:]]}"
        [ $JOBCOUNT -gt 0 ] && echo -n " jobs:${JOBCOUNT//[[:space:]]}"
        echo -n "$reset "
    fi
}

# import git's prompt utilities
export GIT_PS1_SHOWDIRTYSTATE=1
export GIT_PS1_SHOWUNTRACKEDFILES=1
export GIT_PS1_SHOWUPSTREAM='auto'
export GIT_PS1_STATESEPARATOR=" "
source ~/bin/git-prompt.sh

# build up the PS1 prompt
PS1=
PS1+="\n\[$cyan\]\d \T\[$reset\]"   # current date/time
PS1+=" - \[$blue\]\W\[$reset\]"     # current working dir
PS1+="\$(__git_ps1 ' - %s')"        # git status, if applicable
PS1+='`nonzero_return`'             # return code of last command, if not 0
PS1+='`ps1_dirs_jobs`'              # counts of dirs stack / background jobs
PS1+="\n[\[$cyan\]\u@\h\[$reset\]]" # [username@hostname]
PS1+="\\$ "                         # $ character (# if root)
export PS1

# don't ring the terminal bell for tab completion
bind "set bell-style none"

# case-insensitive tab completion
bind "set completion-ignore-case on"

# windows CMD-style tab completion: tab/shift-tab cycle forward/backward through completions
bind "TAB:menu-complete"
bind '"\e[Z":menu-complete-backward'

# always show tab-complete list if more than one is available
bind "set show-all-if-ambiguous on"

# if you've used pushd to create a dir stack, this command cycles from the bottom
alias rotd='pushd -0'

export VISUAL=vim
export EDITOR=$VISUAL

# color highlighting for man pages; from ArchWiki "man page"
man() {
    env LESS_TERMCAP_mb=$'\E[01;31m' \
    LESS_TERMCAP_md=$'\E[01;38;5;74m' \
    LESS_TERMCAP_me=$'\E[0m' \
    LESS_TERMCAP_se=$'\E[0m' \
    LESS_TERMCAP_so=$'\E[38;5;246m' \
    LESS_TERMCAP_ue=$'\E[0m' \
    LESS_TERMCAP_us=$'\E[04;38;5;146m' \
    man "$@"
}

export PATH="$HOME/.cabal/bin:$HOME/.cargo/bin:$HOME/bin:$PATH"

[[ -r "/usr/local/etc/profile.d/bash_completion.sh" ]] && source "/usr/local/etc/profile.d/bash_completion.sh"

# vim: ft=sh
